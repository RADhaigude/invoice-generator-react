name: CI / SonarCloud PR Scan (Invoice Generator)

on:
  pull_request:
    branches:
      - dev   # Run only when PR targets dev branch

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Java (required for Sonar scanner)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Set up Node.js (for React project)
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 5Ô∏è‚É£ SonarCloud Scan (PR Decoration only)
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # required for PR decoration
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=RADhaigude_invoice-generator-react
            -Dsonar.organization=radhaigude
            -Dsonar.sources=.
            -Dsonar.exclusions=node_modules/**,coverage/**,build/**,dist/**,**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}

      # 6Ô∏è‚É£ Notify Teams with PR Quality Gate result
      - name: Notify Teams
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # ‚úÖ Fetch PR Quality Gate status
          STATUS=$(curl -s -u $SONAR_TOKEN: \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react&pullRequest=$PR_NUMBER" \
            | jq -r '.projectStatus.status')

          RESULT="‚ùå FAILED"
          COLOR="FF0000"
          if [ "$STATUS" = "OK" ]; then
            RESULT="‚úÖ PASSED"
            COLOR="0076D7"
          fi

          TARGET="Pull Request #$PR_NUMBER ‚Üí ${{ github.base_ref }}"
          PROJECT_LINK="https://sonarcloud.io/dashboard?id=RADhaigude_invoice-generator-react&pullRequest=$PR_NUMBER"

          # ‚úÖ Fetch detailed PR measures
          METRICS=$(curl -s -u $SONAR_TOKEN: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&pullRequest=$PR_NUMBER&metricKeys=new_lines,bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_hotspots")

          NEW_LINES=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="new_lines") | .value // "0"')
          BUGS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="bugs") | .value // "0"')
          VULNS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value // "0"')
          SMELLS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="code_smells") | .value // "0"')
          COVERAGE=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="coverage") | .value // "N/A"')
          DUP=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value // "0"')
          HOTSPOTS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="security_hotspots") | .value // "0"')

          # ‚úÖ Format Teams message
          FACTS=$(jq -n \
            --arg result "$RESULT" \
            --arg newlines "$NEW_LINES" \
            --arg bugs "$BUGS" \
            --arg vulns "$VULNS" \
            --arg smells "$SMELLS" \
            --arg coverage "$COVERAGE" \
            --arg dup "$DUP%" \
            --arg hotspots "$HOTSPOTS" \
            '[{"name":"Quality Gate","value":$result},{"name":"New Lines","value":$newlines},{"name":"Bugs","value":$bugs},{"name":"Vulnerabilities","value":$vulns},{"name":"Code Smells","value":$smells},{"name":"Coverage","value":$coverage},{"name":"Duplications","value":$dup},{"name":"Security Hotspots","value":$hotspots}]')

          payload=$(jq -n \
            --arg title "üö¶ SonarCloud PR Analysis - Invoice Generator React" \
            --arg target "$TARGET" \
            --arg color "$COLOR" \
            --arg link "$PROJECT_LINK" \
            --argjson facts "$FACTS" \
            '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": $color,
              "summary": "SonarCloud Quality Gate",
              "sections": [{
                "activityTitle": $title,
                "activitySubtitle": $target,
                "facts": $facts,
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "üîó Open in SonarCloud",
                "targets": [{"os": "default", "uri": $link}]
              }]
            }')

          curl -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"
