name: CI / SonarCloud Scan

on:
  push:
    branches: [ dev, master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Get Quality Gate
        run: |
          curl -s -u ${{ secrets.SONAR_TOKEN }}: \
          "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react" \
          -o sonar_quality_gate.json

      - name: Enforce Quality Gate
        run: |
          STATUS=$(jq -r '.projectStatus.status' sonar_quality_gate.json)
          echo "Quality Gate Status: $STATUS"
          if [ "$STATUS" = "ERROR" ]; then
            echo "❌ Quality Gate failed. Blocking pipeline."
            exit 1
          fi

      - name: Generate Reports
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          python3 -m pip install requests openpyxl python-docx pypandoc lxml
          cat <<'EOF' | python3
import requests
import os
import csv
import base64
from openpyxl import Workbook
from docx import Document
import pypandoc

token = os.getenv("SONAR_TOKEN")
project = "RADhaigude_invoice-generator-react"
metrics = "bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,reliability_rating,security_rating,sqale_rating,ncloc,cognitive_complexity"

url = f"https://sonarcloud.io/api/measures/component?component={project}&metricKeys={metrics}"
headers = {"Authorization": "Basic " + base64.b64encode(f"{token}:".encode()).decode()}
r = requests.get(url, headers=headers)
r.raise_for_status()
data = r.json()["component"]["measures"]

# CSV
with open("sonar_report.csv","w",newline="") as f:
    w=csv.writer(f)
    w.writerow(["Metric","Value"])
    for m in data:
        w.writerow([m["metric"],m.get("value","")])

# XLSX
wb=Workbook()
ws=wb.active
ws.title="Sonar"
ws.append(["Metric","Value"])
for m in data:
    ws.append([m["metric"],m.get("value","")])
wb.save("sonar_report.xlsx")

# DOCX
doc=Document()
doc.add_heading("SonarCloud Report",0)
t=doc.add_table(rows=1,cols=2)
hdr=t.rows[0].cells
hdr[0].text,hdr[1].text="Metric","Value"
for m in data:
    row=t.add_row().cells
    row[0].text,row[1].text=m["metric"],m.get("value","")
doc.save("sonar_report.docx")

# Markdown + RTF
md="# SonarCloud Report\n\n| Metric | Value |\n|--------|-------|\n"
for m in data:
    md+=f"| {m['metric']} | {m.get('value','')} |\n"
open("sonar_report.md","w").write(md)
pypandoc.convert_text(md,"rtf",format="md",outputfile="sonar_report.rtf",extra_args=["--standalone"])
print("✅ Reports generated")
EOF

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: sonar-reports
          path: |
            sonar_report.csv
            sonar_report.xlsx
            sonar_report.docx
            sonar_report.md
            sonar_report.rtf

