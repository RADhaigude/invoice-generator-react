name: CI / SonarCloud Scan

on:
  push:
    branches: [ dev, master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      # üîç Run SonarCloud Scan and capture ceTaskId
      - name: SonarCloud Scan
        id: sonar
        uses: SonarSource/sonarcloud-github-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # ‚è≥ Wait for analysis to finish
      - name: Wait for Quality Gate
        run: |
          echo "Fetching task id..."
          TASK_URL="https://sonarcloud.io/api/ce/component?component=RADhaigude_invoice-generator-react"
          echo "Task URL: $TASK_URL"

          # Poll until analysis is complete
          for i in {1..10}; do
            STATUS_JSON=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: "$TASK_URL")
            TASK_STATUS=$(echo "$STATUS_JSON" | jq -r '.queue[0].status // empty')

            if [ "$TASK_STATUS" == "SUCCESS" ]; then
              echo "Analysis complete ‚úÖ"
              break
            else
              echo "Analysis still running... ‚è≥"
              sleep 10
            fi
          done

      # üì• Fetch Quality Gate result
      - name: Fetch Quality Gate status
        run: |
          curl -s -u ${{ secrets.SONAR_TOKEN }}: \
          "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react" \
          -o sonar_quality_gate.json
          cat sonar_quality_gate.json

      # ‚õî Enforce Quality Gate (only on master or PR ‚Üí master)
      - name: Enforce Quality Gate
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
          (github.event_name == 'pull_request' && github.base_ref == 'master')
        run: |
          STATUS=$(jq -r '.projectStatus.status' sonar_quality_gate.json)
          echo "Quality Gate Status: $STATUS"
          if [ "$STATUS" != "OK" ]; then
            echo "‚ùå Quality Gate failed. Blocking pipeline."
            exit 1
          else
            echo "‚úÖ Quality Gate passed."
          fi

      # üîî Teams Notification (always runs)
      - name: Teams Notification
        if: always()
        run: |
          STATUS=$(jq -r '.projectStatus.status' sonar_quality_gate.json || echo "ERROR")
          if [ "$STATUS" == "OK" ]; then
            MSG="‚úÖ SonarCloud Quality Gate PASSED for $GITHUB_REPOSITORY"
          else
            MSG="‚ùå SonarCloud Quality Gate FAILED for $GITHUB_REPOSITORY"
          fi

          curl -H 'Content-Type: application/json' \
          -d "{\"text\": \"$MSG\"}" \
          ${{ secrets.TEAMS_WEBHOOK_URL }}
