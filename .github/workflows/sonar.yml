name: CI / SonarCloud + Reports + Teams Notification

on:
  push:
    branches: [ dev, master ]
  pull_request:
    branches: [ master ] # Trigger on PRs into master

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sonar-ci:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js & tools
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install OS tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq pandoc

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Run tests with coverage
      - name: Run tests with coverage
        run: |
          npm install --save-dev jest-canvas-mock
          echo "import 'jest-canvas-mock';" > src/setupTests.js
          npx jest --coverage --watchAll=false --passWithNoTests --bail=0 \
            --json --outputFile=jest-results.json \
            --coverageReporters=text --coverageReporters=lcov || echo "‚ö†Ô∏è Tests failed"

      # 5Ô∏è‚É£ Build project
      - name: Build
        run: CI=false npm run build --if-present
        env:
          NODE_OPTIONS: --openssl-legacy-provider

      # 6Ô∏è‚É£ SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=RADhaigude_invoice-generator-react
            -Dsonar.organization=radhaigude
            -Dsonar.sources=.
            -Dsonar.exclusions=node_modules/**,coverage/**,build/**,dist/**
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            ${{ github.event_name == 'pull_request' && format('-Dsonar.pullrequest.key={0} -Dsonar.pullrequest.branch={1} -Dsonar.pullrequest.base={2}', github.event.pull_request.number, github.head_ref, github.base_ref) || '' }}

      # 7Ô∏è‚É£ Fetch Quality Gate
      - name: Fetch Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react&pullRequest=${{ github.event.pull_request.number }}" \
              -o sonar_quality_gate.json
          else
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react" \
              -o sonar_quality_gate.json
          fi
          cat sonar_quality_gate.json

      # 8Ô∏è‚É£ Generate Reports
      - name: Generate Reports
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          python3 -m pip install requests openpyxl python-docx pypandoc lxml
          python3 <<'EOF'
import requests
import os
import csv
import base64
from openpyxl import Workbook
from docx import Document
import pypandoc

token = os.getenv("SONAR_TOKEN")
project = "RADhaigude_invoice-generator-react"
metrics = "bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,reliability_rating,security_rating,sqale_rating,ncloc,cognitive_complexity"

url = f"https://sonarcloud.io/api/measures/component?component={project}&metricKeys={metrics}"
headers = {"Authorization": "Basic " + base64.b64encode(f"{token}:".encode()).decode()}
r = requests.get(url, headers=headers)
if r.status_code != 200:
    print("‚ùå Failed to fetch metrics:", r.text)
    exit(1)

data = r.json()["component"]["measures"]

# CSV
with open("sonar_report.csv","w",newline="") as f:
    w=csv.writer(f)
    w.writerow(["Metric","Value"])
    for m in data:
        w.writerow([m["metric"],m.get("value","")])

# XLSX
wb=Workbook()
ws=wb.active
ws.title="Sonar"
ws.append(["Metric","Value"])
for m in data:
    ws.append([m["metric"],m.get("value","")])
wb.save("sonar_report.xlsx")

# DOCX
doc=Document()
doc.add_heading("SonarCloud Report",0)
t=doc.add_table(rows=1,cols=2)
hdr=t.rows[0].cells
hdr[0].text,hdr[1].text="Metric","Value"
for m in data:
    row=t.add_row().cells
    row[0].text,row[1].text=m["metric"],m.get("value","")
doc.save("sonar_report.docx")

# Markdown + RTF
md="# SonarCloud Report\n\n| Metric | Value |\n|--------|-------|\n"
for m in data:
    md+=f"| {m['metric']} | {m.get('value','')} |\n"
open("sonar_report.md","w").write(md)
pypandoc.convert_text(md,"rtf",format="md",outputfile="sonar_report.rtf",extra_args=["--standalone"])
print("‚úÖ Reports generated")
EOF

      # 9Ô∏è‚É£ Notify Teams (only on PRs)
      - name: Notify via Teams
        if: github.event_name == 'pull_request'
        env:
          WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          STATUS=$(jq -r '.projectStatus.status' sonar_quality_gate.json)
          BRANCH=${{ github.head_ref }}
          REPO=${{ github.repository }}
          PR=${{ github.event.pull_request.number }}
          URL="https://sonarcloud.io/project/overview?id=RADhaigude_invoice-generator-react"
          MSG="PR #$PR on $REPO ($BRANCH) - Quality Gate: $STATUS. [View Report]($URL)"
          payload=$(jq -n --arg title "SonarCloud CI Result" --arg text "$MSG" '{title:$title,text:$text}')
          curl -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"

      # üîü Fail if Quality Gate fails (protect master)
      - name: Fail if Quality Gate fails
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
          (github.event_name == 'pull_request' && github.base_ref == 'master')
        run: |
          STATUS=$(jq -r '.projectStatus.status' sonar_quality_gate.json)
          if [ "$STATUS" != "OK" ]; then
            echo "‚ùå Quality Gate is $STATUS. Blocking merge to master."
            exit 1
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload artifacts
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-reports
          path: |
            sonar_quality_gate.json
            sonar_report.csv
            sonar_report.xlsx
            sonar_report.docx
            sonar_report.md
            sonar_report.rtf

