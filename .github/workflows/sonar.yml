name: CI / SonarCloud Scan

on:
  push:
    branches: [ dev, master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Java (Sonar needs 17)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      # 4️⃣ SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=RADhaigude_invoice-generator-react
            -Dsonar.organization=radhaigude
            -Dsonar.sources=.
            -Dsonar.exclusions=node_modules/**,coverage/**,build/**,dist/**
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      # 5️⃣ Fetch Quality Gate JSON
      - name: Fetch Quality Gate status
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Fetching Quality Gate for PR #${{ github.event.pull_request.number }}"
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react&pullRequest=${{ github.event.pull_request.number }}" \
              -o sonar_quality_gate.json
          else
            echo "Fetching Quality Gate for branch ${GITHUB_REF_NAME}"
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react" \
              -o sonar_quality_gate.json
          fi
          cat sonar_quality_gate.json

      # 6️⃣ Enforce Quality Gate
      - name: Enforce Quality Gate
        id: quality_gate
        run: |
          STATUS=$(jq -r '.projectStatus.status' sonar_quality_gate.json)
          echo "Quality Gate Status: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          if [ "$STATUS" != "OK" ]; then
            echo "❌ Quality Gate failed. Blocking pipeline."
            exit 1
          else
            echo "✅ Quality Gate passed."
          fi

      # 7️⃣ Webhook Notification (Teams/Slack)
      - name: Notify via Webhook
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}   # store in repo secrets
        run: |
          STATUS=$(jq -r '.projectStatus.status' sonar_quality_gate.json)
          BRANCH="${GITHUB_REF_NAME}"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET="Pull Request #${{ github.event.pull_request.number }}"
          else
            TARGET="Branch ${BRANCH}"
          fi

          if [ "$STATUS" = "OK" ]; then
            MESSAGE="✅ SonarCloud Quality Gate PASSED for *$TARGET*"
          else
            MESSAGE="❌ SonarCloud Quality Gate FAILED for *$TARGET*"
          fi

          payload=$(jq -n \
            --arg text "$MESSAGE" \
            '{text: $text}')

          echo "Sending notification..."
          curl -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"

