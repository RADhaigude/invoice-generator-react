name: CI / SonarCloud Scan

on:
  push:
    branches: [devops-CI-testing] # Trigger on your desired branches

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  sonarcloud-quality-gate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3Ô∏è‚É£ Build and run tests with Gradle
      - name: Build and run tests
        run: ./gradlew clean build

      
     # 5Ô∏è‚É£ SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=RADhaigude_invoice-generator-react
            -Dsonar.organization=radhaigude
            -Dsonar.sources=.
            -Dsonar.exclusions=node_modules/**,coverage/**,build/**,dist/**,**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      # 5Ô∏è‚É£ Fail pipeline if Quality Gate fails
      - name: Fail if Quality Gate fails
        run: |
          STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=my_project&branch=${GITHUB_REF_NAME}" \
            | jq -r '.projectStatus.status')
          if [ "$STATUS" != "OK" ]; then
            echo "‚ùå Quality Gate failed"
            exit 1
          fi

      # 6Ô∏è‚É£ Notify Teams
      - name: Notify Teams
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          BRANCH_NAME=${GITHUB_REF_NAME}

          STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=my_project&branch=${BRANCH_NAME}" \
            | jq -r '.projectStatus.status')

          if [ "$STATUS" = "OK" ]; then
            RESULT="‚úÖ PASSED"
            COLOR="0076D7"
          else
            RESULT="‚ùå FAILED"
            COLOR="FF0000"
          fi

          TARGET="Branch ${BRANCH_NAME}"
          PROJECT_LINK="https://sonarcloud.io/dashboard?id=my_project&branch=${BRANCH_NAME}"

          METRICS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=my_project&branch=${BRANCH_NAME}&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_hotspots")

          BUGS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="bugs") | .value // "0"')
          VULNS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value // "0"')
          SMELLS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="code_smells") | .value // "0"')
          COVERAGE=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="coverage") | .value // "0"')
          DUP=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value // "0"')
          HOTSPOTS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="security_hotspots") | .value // "0"')

          FACTS=$(jq -n \
            --arg result "$RESULT" \
            --arg bugs "$BUGS" \
            --arg vulns "$VULNS" \
            --arg smells "$SMELLS" \
            --arg coverage "$COVERAGE%" \
            --arg dup "$DUP%" \
            --arg hotspots "$HOTSPOTS" \
            '[ 
              {"name":"Quality Gate","value":$result},
              {"name":"Bugs","value":$bugs},
              {"name":"Vulnerabilities","value":$vulns},
              {"name":"Code Smells","value":$smells},
              {"name":"Coverage","value":$coverage},
              {"name":"Duplicated Lines %","value":$dup},
              {"name":"Security Hotspots","value":$hotspots}
            ]')

          payload=$(jq -n \
            --arg title "üö¶ SonarCloud Analysis - HmmsFrontend" \
            --arg target "$TARGET" \
            --arg color "$COLOR" \
            --arg link "$PROJECT_LINK" \
            --argjson facts "$FACTS" \
            '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": $color,
              "summary": "SonarCloud Quality Gate",
              "sections": [{
                "activityTitle": $title,
                "activitySubtitle": "Target: \($target)",
                "facts": $facts,
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "üîó Open in SonarCloud",
                "targets": [{"os": "default", "uri": $link}]
              }]
            }')

          curl -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"


