name: CI/CD / SonarCloud Scan

on:
  push:
    branches: [ dev, master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Tooling
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install jq and curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # 3Ô∏è‚É£ Cache Node modules
      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 5Ô∏è‚É£ Run tests with coverage
      - name: Run tests with coverage
        run: |
          npm install --save-dev jest-canvas-mock
          echo "import 'jest-canvas-mock';" > src/setupTests.js
          npx jest --coverage --watchAll=false --passWithNoTests --bail=0 \
            --json --outputFile=jest-results.json \
            --coverageReporters=text --coverageReporters=lcov --coverageReporters=html || echo "‚ö†Ô∏è Some tests failed, but continuing..."

      # 6Ô∏è‚É£ Build project
      - name: Build project
        run: CI=false npm run build --if-present
        env:
          NODE_OPTIONS: --openssl-legacy-provider

      # 7Ô∏è‚É£ SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=RADhaigude_invoice-generator-react
            -Dsonar.organization=radhaigude
            -Dsonar.sources=.
            -Dsonar.exclusions=node_modules/**,coverage/**,build/**,dist/**,**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.python.version=3.11

            # 8Ô∏è‚É£ Fetch ALL project analyses + full file-level reports
      - name: Fetch full SonarCloud project reports
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mkdir -p sonar_reports
          echo "üì° Fetching project list from SonarCloud..."
          curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/projects/search?organization=radhaigude&ps=500" \
            -o projects.json

          PROJECT_KEYS=$(jq -r '.components[].key' projects.json)
          echo "Found projects:"
          echo "$PROJECT_KEYS"

          for KEY in $PROJECT_KEYS; do
            echo "üîç Collecting full report for $KEY"

            # Wait for Quality Gate
            for i in {1..15}; do
              curl -s -u "$SONAR_TOKEN:" \
                "https://sonarcloud.io/api/qualitygates/project_status?projectKey=$KEY" \
                -o qg.json || true
              STATUS=$(jq -r '.projectStatus.status // empty' qg.json)
              if [ -n "$STATUS" ]; then
                echo "‚úÖ Quality Gate: $STATUS"
                break
              else
                echo "‚è≥ Waiting for results... retrying in 15s"
                sleep 15
              fi
            done

            # Metrics
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/measures/component?component=$KEY&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density" \
              -o metrics.json

            # Issues (all, paginated)
            echo "[]" > issues.json
            PAGE=1
            while true; do
              RESP=$(curl -s -u "$SONAR_TOKEN:" \
                "https://sonarcloud.io/api/issues/search?componentKeys=$KEY&ps=500&p=$PAGE")
              COUNT=$(echo "$RESP" | jq '.issues | length')
              if [ "$COUNT" -eq 0 ]; then break; fi
              jq -s '.[0] + .[1]' issues.json <(echo "$RESP" | jq '.issues') > tmp.json
              mv tmp.json issues.json
              PAGE=$((PAGE+1))
            done

            # Coverage
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/measures/component_tree?component=$KEY&metricKeys=coverage,line_coverage,uncovered_lines&ps=500" \
              -o coverage.json

            # Duplications & hotspots
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/measures/component?component=$KEY&metricKeys=duplicated_lines,duplicated_blocks,security_hotspots" \
              -o extra.json

            # Combine into one report
            jq -n \
              --slurpfile metrics metrics.json \
              --slurpfile issues issues.json \
              --slurpfile coverage coverage.json \
              --slurpfile extra extra.json \
              --arg project "$KEY" \
              --arg status "$STATUS" \
              '{project: $project, quality_gate: $status, metrics: $metrics[0].component, issues: $issues, coverage: $coverage[0], extra: $extra[0]}' \
              > sonar_reports/${KEY}_full_report.json
          done

          # Merge all project reports
          jq -s '.' sonar_reports/*_full_report.json > sonar_all_projects_full.json


            # 1Ô∏è‚É£ Wait for Quality Gate
            for i in {1..15}; do
              curl -s -u "$SONAR_TOKEN:" \
                "https://sonarcloud.io/api/qualitygates/project_status?projectKey=$KEY" \
                -o qg.json || true
              STATUS=$(jq -r '.projectStatus.status // empty' qg.json)
              if [ -n "$STATUS" ]; then
                echo "‚úÖ Quality Gate: $STATUS"
                break
              else
                echo "‚è≥ Waiting for results... retrying in 15s"
                sleep 15
              fi
            done

            # 2Ô∏è‚É£ Metrics
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/measures/component?component=$KEY&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density" \
              -o metrics.json

            # 3Ô∏è‚É£ Issues (all, paginated)
            > issues.json
            PAGE=1
            while true; do
              RESP=$(curl -s -u "$SONAR_TOKEN:" \
                "https://sonarcloud.io/api/issues/search?componentKeys=$KEY&ps=500&p=$PAGE")
              COUNT=$(echo "$RESP" | jq '.issues | length')
              if [ "$COUNT" -eq 0 ]; then break; fi
              echo "$RESP" | jq '.issues' >> issues.json
              PAGE=$((PAGE+1))
            done

            # 4Ô∏è‚É£ Coverage per file
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/measures/component_tree?component=$KEY&metricKeys=coverage,line_coverage,uncovered_lines&ps=500" \
              -o coverage.json

            # 5Ô∏è‚É£ Duplications & hotspots
            curl -s -u "$SONAR_TOKEN:" \
              "https://sonarcloud.io/api/measures/component?component=$KEY&metricKeys=duplicated_lines,duplicated_blocks,security_hotspots" \
              -o extra.json

            # Combine all into one report per project
            jq -n \
              --slurpfile metrics metrics.json \
              --slurpfile issues issues.json \
              --slurpfile coverage coverage.json \
              --slurpfile extra extra.json \
              --arg project "$KEY" \
              --arg status "$STATUS" \
              '{project: $project, quality_gate: $status, metrics: $metrics[0].component, issues: $issues, coverage: $coverage[0], extra: $extra[0]}' \
              > sonar_reports/${KEY}_full_report.json

          # Merge all project reports
          jq -s '.' sonar_reports/*_full_report.json > sonar_all_projects_full.json

      # 9Ô∏è‚É£ Fail if ANY project Quality Gate failed
      - name: Enforce Quality Gate
        run: |
          FAILED=$(jq '[.[] | select(.quality_gate != "OK")] | length' sonar_all_projects_full.json)
          if [ "$FAILED" -gt 0 ]; then
            echo "‚ùå One or more projects FAILED Quality Gate!"
            jq '.[] | select(.quality_gate != "OK")' sonar_all_projects_full.json
            exit 1
          else
            echo "‚úÖ All projects PASSED Quality Gates."

      # üîü Upload consolidated full JSON reports
      - name: Upload Sonar Full Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sonar-all-projects-full
          path: sonar_all_projects_full.json

      # 1Ô∏è‚É£1Ô∏è‚É£ Notify Teams with ALL projects summary
      - name: Notify Teams
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          echo "üì° Preparing Teams summary for ALL projects..."
          FACTS=$(jq -r '.[] | 
            "- **Project:** \(.project)\n  ‚Ä¢ Quality Gate: \(.quality_gate)\n  ‚Ä¢ Bugs: \(.metrics.measures[] | select(.metric=="bugs") | .value)\n  ‚Ä¢ Vulnerabilities: \(.metrics.measures[] | select(.metric=="vulnerabilities") | .value)\n  ‚Ä¢ Code Smells: \(.metrics.measures[] | select(.metric=="code_smells") | .value)\n  ‚Ä¢ Coverage: \(.metrics.measures[] | select(.metric=="coverage") | .value)%\n  ‚Ä¢ Duplication: \(.metrics.measures[] | select(.metric=="duplicated_lines_density") | .value)%\n"' sonar_all_projects_full.json)

          payload=$(jq -n \
            --arg title "üö¶ SonarCloud CI/CD Full Quality Gate Report" \
            --arg facts "$FACTS" \
            --arg dash "https://sonarcloud.io/organizations/radhaigude/projects" \
            '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "0076D7",
              "summary": "SonarCloud Full Quality Gate Report",
              "sections": [{
                "activityTitle": $title,
                "text": $facts,
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "üîó View Dashboard",
                "targets": [{ "os": "default", "uri": $dash }]
              }]
            }')

          echo "Sending MessageCard to Teams..."
          curl -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"
