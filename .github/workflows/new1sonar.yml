name: CI / SonarCloud Scan

on:
  push:
    branches: [ dev, master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 50

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Tooling
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies & fix vulnerabilities
        run: |
          npm install --save-dev jest jest-canvas-mock @babel/preset-react
          npm audit fix --force
          echo "import 'jest-canvas-mock';" > src/setupTests.js
          # Create Babel config to handle JSX
          echo '{
            "presets": ["@babel/preset-env", "@babel/preset-react"]
          }' > babel.config.json

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # 3️⃣ Cache Node modules
      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4️⃣ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 5️⃣ Run tests with coverage
      - name: Run tests with coverage
        run: |
          npx jest --coverage --watchAll=false --passWithNoTests --bail=0 \
            --json --outputFile=jest-results.json \
            --coverageReporters=text --coverageReporters=lcov --coverageReporters=html || echo "⚠️ Some tests failed, continuing..."

      # 6️⃣ Build project
      - name: Build project
        run: CI=false npm run build --if-present
        env:
          NODE_OPTIONS: --openssl-legacy-provider

      # 7️⃣ SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=RADhaigude_invoice-generator-react
            -Dsonar.organization=radhaigude
            -Dsonar.sources=.
            -Dsonar.exclusions=node_modules/**,coverage/**,build/**,dist/**,**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.python.version=3.11

      # 8️⃣ Fetch SonarCloud project metrics + Quality Gate
      - name: Fetch SonarCloud Quality Gate
        run: |
          mkdir -p sonar_reports
          curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react" \
            -o sonar_reports/qg.json
          STATUS=$(jq -r '.projectStatus.status' sonar_reports/qg.json)
          echo "Quality Gate Status: $STATUS"
          if [ "$STATUS" != "OK" ]; then
            echo "❌ Quality Gate failed!"
            exit 1
          fi
          echo "✅ Quality Gate passed."

      # 9️⃣ Upload Sonar Report JSON
      - name: Upload Sonar Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: sonar_reports/qg.json

      
