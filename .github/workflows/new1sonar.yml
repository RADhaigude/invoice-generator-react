name: CI / SonarCloud Scan

on:
  push:
    branches: dev
  pull_request:
    branches: dev

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud-quality-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Java (required by SonarScanner)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Install dependencies (if Node.js project)
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm install

      # 4Ô∏è‚É£ Run SonarCloud Scan
      - name: SonarCloud Scan
        id: sonar_scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          projectKey: RADhaigude_invoice-generator-react
          organization: YOUR_ORG
          token: ${{ secrets.SONAR_TOKEN }}

      # 5Ô∏è‚É£ Fetch SonarCloud Quality Gate results
      - name: Get Quality Gate Status
        id: sonar_results
        run: |
          STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react" \
            | jq -r '.projectStatus.status')
          BUGS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=bugs" \
            | jq -r '.component.measures[0].value')
          VULNS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=vulnerabilities" \
            | jq -r '.component.measures[0].value')
          SMELLS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=code_smells" \
            | jq -r '.component.measures[0].value')
          COVERAGE=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=coverage" \
            | jq -r '.component.measures[0].value')
          DUP=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=duplicated_lines_density" \
            | jq -r '.component.measures[0].value')

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "bugs=$BUGS" >> $GITHUB_OUTPUT
          echo "vulns=$VULNS" >> $GITHUB_OUTPUT
          echo "smells=$SMELLS" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "dup=$DUP" >> $GITHUB_OUTPUT

      # 6Ô∏è‚É£ Notify Teams with MessageCard
      - name: Notify Teams
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          STATUS="${{ steps.sonar_results.outputs.status }}"
          BUGS="${{ steps.sonar_results.outputs.bugs }}"
          VULNS="${{ steps.sonar_results.outputs.vulns }}"
          SMELLS="${{ steps.sonar_results.outputs.smells }}"
          COVERAGE="${{ steps.sonar_results.outputs.coverage }}"
          DUP="${{ steps.sonar_results.outputs.dup }}"
          
          if [ "$STATUS" = "OK" ]; then
            RESULT="‚úÖ PASSED"
          else
            RESULT="‚ùå FAILED"
          fi
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET="Pull Request #${{ github.event.pull_request.number }}"
          else
            TARGET="Branch ${GITHUB_REF_NAME}"
          fi
          
          payload=$(jq -n \
            --arg title "üö¶ SonarCloud CI/CD Quality Gate Report" \
            --arg target "$TARGET" \
            --arg result "$RESULT" \
            --arg bugs "$BUGS" \
            --arg vulns "$VULNS" \
            --arg smells "$SMELLS" \
            --arg coverage "$COVERAGE%" \
            --arg dup "$DUP%" \
            --arg dash "https://sonarcloud.io/project/overview?id=RADhaigude_invoice-generator-react" \
            '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "0076D7",
              "summary": "SonarCloud Quality Gate Report",
              "sections": [{
                "activityTitle": $title,
                "activitySubtitle": "Target: \($target)",
                "facts": [
                  {"name": "Quality Gate", "value": $result},
                  {"name": "Bugs", "value": $bugs},
                  {"name": "Vulnerabilities", "value": $vulns},
                  {"name": "Code Smells", "value": $smells},
                  {"name": "Coverage", "value": $coverage},
                  {"name": "Duplication", "value": $dup}
                ],
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "üîó View Dashboard",
                "targets": [{ "os": "default", "uri": $dash }]
              }]
            }')
          
          echo "Sending MessageCard to Teams..."
          curl -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"
