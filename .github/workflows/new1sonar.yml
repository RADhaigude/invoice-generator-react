name: CI / SonarCloud Scan

on:
  push:
    branches: dev
  pull_request:
    branches: dev

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud-quality-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Java (required by SonarScanner)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Install dependencies (if Node.js project)
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm install

     
      # 5Ô∏è‚É£ SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=RADhaigude_invoice-generator-react
            -Dsonar.organization=radhaigude
            -Dsonar.sources=.
            -Dsonar.exclusions=node_modules/**,coverage/**,build/**,dist/**,**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      # 5Ô∏è‚É£ Fetch SonarCloud Quality Gate results
      - name: Get Quality Gate Status
        id: sonar_results
        run: |
          STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=RADhaigude_invoice-generator-react" \
            | jq -r '.projectStatus.status')
          BUGS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=bugs" \
            | jq -r '.component.measures[0].value')
          VULNS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=vulnerabilities" \
            | jq -r '.component.measures[0].value')
          SMELLS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=code_smells" \
            | jq -r '.component.measures[0].value')
          COVERAGE=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=coverage" \
            | jq -r '.component.measures[0].value')
          DUP=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/measures/component?component=RADhaigude_invoice-generator-react&metricKeys=duplicated_lines_density" \
            | jq -r '.component.measures[0].value')

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "bugs=$BUGS" >> $GITHUB_OUTPUT
          echo "vulns=$VULNS" >> $GITHUB_OUTPUT
          echo "smells=$SMELLS" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "dup=$DUP" >> $GITHUB_OUTPUT

      - name: Notify Teams
  if: always()
  env:
    WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
  run: |
    STATUS="${{ steps.sonar_results.outputs.status }}"
    if [ "$STATUS" = "OK" ]; then 
      RESULT="‚úÖ PASSED"
      COLOR="0076D7"   # Blue/Green (success)
    else 
      RESULT="‚ùå FAILED"
      COLOR="FF0000"   # Red (fail)
    fi
    TARGET="Branch ${GITHUB_REF_NAME}"

    # Build facts dynamically from conditions
    FACTS=$(echo '${{ steps.sonar_results.outputs.conditions }}' | jq -s 'map({
      name: .metricKey,
      value: (.actualValue + " (threshold: " + .errorThreshold + ", status: " + .status + ")")
    })')

    payload=$(jq -n \
      --arg title "üö¶ SonarCloud Quality Gate Report" \
      --arg target "$TARGET" \
      --arg result "$RESULT" \
      --arg color "$COLOR" \
      --argjson facts "$FACTS" \
      '{
        "@type": "MessageCard",
        "@context": "http://schema.org/extensions",
        "themeColor": $color,
        "summary": "SonarCloud Quality Gate",
        "sections": [{
          "activityTitle": $title,
          "activitySubtitle": "Target: \($target)",
          "facts": [{"name": "Overall", "value": $result}] + $facts,
          "markdown": true
        }]
      }')

    curl -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL"
